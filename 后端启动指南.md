# 后端启动完整指南

## 📋 准备工作

### 1. 确认环境

```bash
# 检查Python版本（需要3.10+）
python --version

# 检查pip是否可用
pip --version

# 确认当前目录
pwd  # 或 cd （Windows）
# 应该在项目根目录: F:\CodeProject\dify-reChat
```

### 2. 确认数据库已配置

- 数据库 `dify_rechat` 已创建
- `backend/.env` 文件中的数据库连接信息正确

---

## 🚀 启动步骤

### 方法1: 命令行启动（完整步骤）

#### 第一次启动

```bash
# 1. 进入后端目录
cd backend

# 2. 创建Python虚拟环境
python -m venv venv

# 3. 激活虚拟环境
# Windows PowerShell/CMD:
venv\Scripts\activate

# macOS/Linux:
# source venv/bin/activate

# 激活成功后，命令行前会显示 (venv) 标识

# 4. 升级pip（可选但推荐）
python -m pip install --upgrade pip

# 5. 安装所有依赖
pip install -r requirements.txt

# 6. 测试数据库连接
python test_connection.py

# 如果看到 ✅ 连接成功，说明配置正确

# 7. 启动后端服务
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

#### 后续启动（虚拟环境已创建）

```bash
# 1. 进入后端目录
cd backend

# 2. 激活虚拟环境
venv\Scripts\activate

# 3. 启动服务
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

---

### 方法2: 使用批处理脚本（Windows推荐）

```bash
# 双击运行
start_backend.bat

# 或命令行运行
start_backend.bat
```

脚本会自动：
- 检查并创建虚拟环境
- 激活虚拟环境
- 安装/更新依赖
- 启动后端服务

---

### 方法3: VSCode中启动

#### 使用集成终端

1. 在VSCode中打开项目
2. 打开终端（Ctrl + `）
3. 执行启动命令：

```bash
cd backend
venv\Scripts\activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

#### 使用调试配置

创建 `.vscode/launch.json`：

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "FastAPI - 后端",
            "type": "python",
            "request": "launch",
            "module": "uvicorn",
            "args": [
                "app.main:app",
                "--reload",
                "--host",
                "0.0.0.0",
                "--port",
                "8000"
            ],
            "cwd": "${workspaceFolder}/backend",
            "env": {
                "PYTHONPATH": "${workspaceFolder}/backend"
            },
            "console": "integratedTerminal"
        }
    ]
}
```

然后按 `F5` 启动调试。

---

## ✅ 启动成功标志

### 正常启动输出

```
INFO:     Will watch for changes in these directories: ['F:\\CodeProject\\dify-reChat\\backend']
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [xxxxx] using WatchFiles
INFO:     Started server process [xxxxx]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

### 验证服务运行

**1. 健康检查**
```bash
# 浏览器访问或使用curl
curl http://localhost:8000/health

# 应该返回
{"status":"healthy"}
```

**2. API文档**
```
浏览器访问: http://localhost:8000/api/docs
应该能看到Swagger UI界面，显示所有API端点
```

**3. 根路径**
```
浏览器访问: http://localhost:8000/
应该返回项目信息JSON
```

---

## 🔧 启动参数详解

### 基本参数

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

| 参数 | 说明 | 默认值 | 开发建议 |
|------|------|--------|---------|
| `app.main:app` | FastAPI应用路径 | - | 必填 |
| `--reload` | 代码修改自动重启 | False | 开发环境开启 |
| `--host` | 监听地址 | 127.0.0.1 | 0.0.0.0允许外部访问 |
| `--port` | 端口号 | 8000 | 按需修改 |

### 其他有用参数

```bash
# 指定不同端口
uvicorn app.main:app --reload --port 8001

# 仅本地访问
uvicorn app.main:app --reload --host 127.0.0.1 --port 8000

# 设置日志级别
uvicorn app.main:app --reload --log-level debug

# 设置工作进程数（生产环境，不要和--reload一起用）
uvicorn app.main:app --workers 4 --host 0.0.0.0 --port 8000
```

---

## ⚠️ 常见问题

### 问题1: 提示 `uvicorn: command not found`

**原因**: uvicorn未安装或虚拟环境未激活

**解决**:
```bash
# 确保虚拟环境已激活（提示符前有(venv)）
venv\Scripts\activate

# 重新安装uvicorn
pip install uvicorn[standard]

# 或重新安装所有依赖
pip install -r requirements.txt
```

---

### 问题2: 数据库连接失败

**错误信息**: `Can't connect to MySQL server` 或 `Access denied`

**解决步骤**:

```bash
# 1. 测试数据库连接
python test_connection.py

# 2. 检查.env配置
type .env  # Windows
# cat .env  # macOS/Linux

# 3. 手动测试MySQL连接
mysql -h 43.143.8.251 -P 3306 -u shy -p
# 输入密码: 20040614aaa@shy

# 4. 确认数据库存在
mysql -h 43.143.8.251 -P 3306 -u shy -p
USE dify_rechat;
SHOW TABLES;
```

---

### 问题3: 端口被占用

**错误信息**: `Address already in use` 或 `OSError: [Errno 48]`

**解决方案1: 换端口**
```bash
uvicorn app.main:app --reload --port 8001
```

**解决方案2: 关闭占用端口的进程（Windows）**
```bash
# 查找占用8000端口的进程
netstat -ano | findstr :8000

# 记下PID（最后一列数字）
# 终止进程
taskkill /PID <进程ID> /F
```

**解决方案3: 关闭占用端口的进程（macOS/Linux）**
```bash
# 查找占用8000端口的进程
lsof -i :8000

# 终止进程
kill -9 <PID>
```

---

### 问题4: 导入错误

**错误信息**: `ModuleNotFoundError: No module named 'xxx'`

**解决**:
```bash
# 确保在backend目录
cd backend

# 确保虚拟环境已激活
venv\Scripts\activate

# 重新安装依赖
pip install -r requirements.txt

# 如果还有问题，删除虚拟环境重建
deactivate
rmdir /s venv  # Windows
# rm -rf venv  # macOS/Linux
python -m venv venv
venv\Scripts\activate
pip install -r requirements.txt
```

---

### 问题5: SQLAlchemy错误

**错误信息**: `Attribute name 'metadata' is reserved`

**原因**: 这个问题已经修复，`metadata` 字段已改为 `meta_data`

**解决**: 确保使用最新的代码，如果还有问题：

```bash
# 重新拉取最新代码或检查文件
# backend/app/models/message.py 中应该是 meta_data 而不是 metadata
```

---

### 问题6: Python虚拟环境激活失败（Windows PowerShell）

**错误信息**: `无法加载文件，因为在此系统上禁止运行脚本`

**解决**:
```powershell
# 以管理员身份运行PowerShell
Set-ExecutionPolicy RemoteSigned -Scope CurrentUser

# 然后重新激活
venv\Scripts\activate
```

**或使用CMD代替PowerShell**:
```bash
# 在开始菜单搜索 cmd
# 进入项目目录后
cd backend
venv\Scripts\activate
```

---

## 🔄 开发流程

### 日常开发启动流程

```bash
# 1. 启动后端（保持运行）
cd backend
venv\Scripts\activate
uvicorn app.main:app --reload

# 2. 修改代码
# 代码保存后会自动重启，无需手动重启

# 3. 测试API
# 访问 http://localhost:8000/api/docs

# 4. 停止服务
# 按 Ctrl+C
```

### 修改模型后的流程

如果修改了数据库模型（`app/models/`）：

```bash
# 1. 停止服务（Ctrl+C）

# 2. 创建迁移
alembic revision --autogenerate -m "描述修改内容"

# 3. 执行迁移
alembic upgrade head

# 4. 重新启动
uvicorn app.main:app --reload
```

---

## 📊 开发监控

### 查看日志

后端日志会直接输出到终端，包括：
- 请求日志
- 错误信息
- 数据库查询（DEBUG模式下）

### 实时监控

```bash
# 启动时会显示
INFO: Will watch for changes in these directories: ['...']

# 代码修改后会看到
INFO: Detected changes in 'xxx.py'. Reloading...
INFO: Started reloader process [xxxxx]
```

### API测试

```bash
# 使用Swagger UI（推荐）
http://localhost:8000/api/docs

# 使用curl
curl -X GET http://localhost:8000/health
curl -X GET http://localhost:8000/api/docs

# 使用Postman或其他API测试工具
# 导入 http://localhost:8000/api/openapi.json
```

---

## 🎯 快速参考

### 完整启动命令（复制粘贴）

**首次启动**:
```bash
cd backend && python -m venv venv && venv\Scripts\activate && pip install -r requirements.txt && python test_connection.py && uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**日常启动**:
```bash
cd backend && venv\Scripts\activate && uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 重要地址

- 后端服务: http://localhost:8000
- API文档: http://localhost:8000/api/docs
- ReDoc文档: http://localhost:8000/api/redoc
- 健康检查: http://localhost:8000/health

### 常用命令

```bash
# 测试数据库连接
python test_connection.py

# 查看安装的包
pip list

# 生成requirements.txt
pip freeze > requirements.txt

# 查看Uvicorn版本
uvicorn --version

# 查看FastAPI版本
pip show fastapi
```

---

## 📚 相关文档

- [START_DEVELOPMENT.md](START_DEVELOPMENT.md) - 完整开发环境指南
- [开始使用-远程数据库.txt](开始使用-远程数据库.txt) - 远程数据库配置
- [README.md](README.md) - 项目总览
- [backend/README.md](backend/README.md) - 后端详细文档

---

**启动成功后，别忘了启动前端！** 🚀

查看前端启动指南：双击运行 `start_frontend.bat` 或查看文档。
